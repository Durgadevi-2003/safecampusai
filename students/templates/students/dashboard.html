{% extends "base.html" %}
{% block content %}
{% load custom_filters %}
<html>
  <head>
    <!-- 💬 SmartCare Chatbot -->
<style>
 /* Chatbot Button */
.chatbot-toggle {
  position: fixed;
  bottom: 25px;
  right: 25px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 50%;
  width: 55px;
  height: 55px;
  font-size: 22px;
  cursor: pointer;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
}

/* Chatbot Container */
.chatbot-container {
  display: none;
  flex-direction: column;
  justify-content: space-between;
  position: fixed;
  bottom: 90px;
  right: 25px;
  width: 320px;
  height: 420px;
  background: #ffffff;
  border-radius: 15px;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  overflow: hidden;
  font-family: "Segoe UI", sans-serif;
}

/* Header */
.chatbot-header {
  background-color: #007bff;
  color: white;
  padding: 12px;
  font-weight: bold;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* Close button */
.close-btn {
  background: none;
  border: none;
  color: white;
  font-size: 16px;
  cursor: pointer;
}

/* Chat body */
.chatbot-body {
  flex: 1;
  padding: 10px;
  overflow-y: auto;
  background-color: #f1f1f1;
}

/* Messages */
.bot-message,
.user-message {
  margin: 8px 0;
  padding: 8px 12px;
  border-radius: 15px;
  max-width: 80%;
  word-wrap: break-word;
  font-size: 14px;
  line-height: 1.4;
}

/* Bot message (left side) */
.bot-message {
  background-color: #e2e2e2;
  color: #000;
  align-self: flex-start;
}

/* User message (right side) */
.user-message {
  background-color: #007bff;
  color: #fff;
  align-self: flex-end;
  margin-left: auto;
}

/* Input area */
.chatbot-input {
  display: flex;
  padding: 8px;
  border-top: 1px solid #ddd;
  background-color: #fff;
}

.chatbot-input input {
  flex: 1;
  padding: 6px 10px;
  border: 1px solid #ccc;
  border-radius: 20px;
  outline: none;
}

.chatbot-input button {
  margin-left: 6px;
  padding: 6px 10px;
  border: none;
  border-radius: 50%;
  background-color: #007bff;
  color: white;
  cursor: pointer;
}

</style>
  </head>
  <body>
<div class="container mt-5">
    <h2 class="mb-4">📊 Student Dashboard</h2>

    <!-- Quick Action Cards -->
    <div class="row">
        <div class="col-md-4">
            <div class="card shadow-sm mb-3">
                <div class="card-body text-center">
                    <h5 class="card-title">➕ Add Daily Behavior</h5>
                    <a href="{% url 'upload_behavior' %}" class="btn btn-primary">Upload Behavior</a>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm mb-3">
                <div class="card-body text-center">
                     <h5 class="card-title">🌞 Daily Care / Health Tip</h5>
    <p class="card-text">{{ daily_tip }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm mb-3">
                <div class="card-body text-center">
                    <h5 class="card-title">🧠 Recovery Tracker</h5>
      <p class="card-text">Track your daily mood, cravings & progress visually.</p>
      <a href="{% url 'addiction_dashboard' %}" class="btn btn-primary">
        View Progress
      </a>
                </div>
            </div>
        </div>
    </div>
  


 

    <!-- Latest Behavior -->
    {% if latest_behavior %}
    <div class="card mt-4 shadow-sm">
        <div class="card-body">
            <h5>📌 Latest Behavior ({{ latest_behavior.date }})</h5>
            <ul>
                <li>Screen time: {{ latest_behavior.screen_time_hrs }} hrs</li>
                <li>Night usage: {{ latest_behavior.night_usage_hrs }} hrs</li>
                <li>Sleep: {{ latest_behavior.sleep_hours }} hrs</li>
                <li>Social apps: {{ latest_behavior.app_social_hrs }} hrs</li>
                <li>Entertainment: {{ latest_behavior.app_entertainment_hrs }} hrs</li>
                <li>Education: {{ latest_behavior.app_education_hrs }} hrs</li>
            </ul>

            <!-- Progress Bars -->
            <h6>Progress Overview</h6>
            <div class="progress mb-2">
                <div class="progress-bar bg-info" role="progressbar" 
                     style="width: {{ latest_behavior.screen_time_hrs|floatformat:1|mul:8 }}%;" 
                     aria-valuenow="{{ latest_behavior.screen_time_hrs }}" aria-valuemin="0" aria-valuemax="12">
                    Screen Time: {{ latest_behavior.screen_time_hrs }} hrs
                </div>
            </div>
            <div class="progress mb-2">
                <div class="progress-bar bg-success" role="progressbar" 
                     style="width: {{ latest_behavior.sleep_hours|floatformat:1|mul:10 }}%;" 
                     aria-valuenow="{{ latest_behavior.sleep_hours }}" aria-valuemin="0" aria-valuemax="12">
                    Sleep: {{ latest_behavior.sleep_hours }} hrs
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Latest Prediction -->
    {% if latest_prediction %}
    <div class="card mt-4 shadow-sm border-success">
        <div class="card-body">
            <h5>🧠 Latest Prediction</h5>
            <p><strong>Risk Label:</strong> {{ latest_prediction.risk_label }}</p>
            <p><strong>Risk Score:</strong> {{ latest_prediction.risk_score|floatformat:2 }}</p>
        </div>
    </div>
    {% endif %}

    <!-- Charts -->
     <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
  <!-- Screen Time Chart -->
  <div class="p-6 bg-white rounded-2xl shadow-md">
    <h4 class="text-lg font-bold mb-3 flex items-center gap-2">
      📱 Screen Time Trend
    </h4>
    <canvas id="screenTimeChart" height="180"></canvas>
    <button onclick="screenChart.resetZoom()" class="text-blue-600 mt-2 underline">Reset Zoom</button>

  </div>

  <!-- Risk Score Chart -->
  <div class="p-6 bg-white rounded-2xl shadow-md">
     
    <h4 class="text-lg font-bold mb-3 flex items-center gap-2">
      ⚠️ Risk Score Trend
    </h4>
    <button onclick="riskChart.resetZoom()" class="text-pink-600 mt-2 underline">Reset Zoom</button>

    <canvas id="riskScoreChart" height="180"></canvas>
  </div>
  <!-- Chatbot Button -->
<button onclick="toggleChatbot()" class="chatbot-toggle">💬</button>

<!-- Chatbot Box -->
<div id="chatbot" class="chatbot-container">
  <div class="chatbot-header">
    🤖 SmartCare Bot
    <button onclick="toggleChatbot()" class="close-btn">✖</button>
  </div>
  <div id="chatBody" class="chatbot-body">
    <div class="bot-message">Hi there! 👋 I'm SmartCare Bot. How can I help you today?</div>
  </div>
  <div class="chatbot-input">
    <input id="userInput" type="text" placeholder="Type your question..." />
    <button onclick="sendMessage()">Send</button>
    <button onclick="startVoice()">🎙️</button>
  </div>
</div>

<div class="card mt-4 shadow-sm">
  <div class="card-header bg-primary text-white">
    🎯 Gamification & Rewards
  </div>
  <div class="card-body">
    <h5>🔥 Login Streak: {{ streak.current_streak }} days</h5>
    <p>🏆 Best Streak: {{ streak.best_streak }} days</p>

    <hr>

    <h5>🌟 Your Badges:</h5>
    {% for ub in user.badges.all %}
      <span style="font-size:24px;">{{ ub.badge.icon }}</span>
      <small>{{ ub.badge.name }}</small><br>
    {% empty %}
      <p class="text-muted">No badges earned yet. Keep going! 💪</p>
    {% endfor %}

    <hr>
    <a href="{% url 'leaderboard' %}" class="btn btn-outline-primary btn-sm">View Leaderboard</a>
  </div>
</div>
<div class="card mt-4 p-3">
  <h5>🔍 Check Content for Drug Risk</h5>
  <textarea id="textInput" class="form-control" placeholder="Enter a message or post..."></textarea>
  <button class="btn btn-primary mt-2" onclick="analyzeText()">Analyze Text</button>
  <p id="textResult" class="mt-2"></p>
</div>
 
<!-- Chart.js -->
 <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-3d@0.1.8/dist/chartjs-plugin-3d.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <script>
  const dates = {{ dates|safe }};
  const screenTimes = {{ screen_times|safe }};
  const riskScores = {{ risk_scores|safe }};

  // --- Create gradient fills dynamically ---
  const ctx1 = document.getElementById('screenTimeChart').getContext('2d');
  const gradient1 = ctx1.createLinearGradient(0, 0, 0, 400);
  gradient1.addColorStop(0, 'rgba(54,162,235,0.5)');
  gradient1.addColorStop(1, 'rgba(54,162,235,0)');

  const ctx2 = document.getElementById('riskScoreChart').getContext('2d');
  const gradient2 = ctx2.createLinearGradient(0, 0, 0, 400);
  gradient2.addColorStop(0, 'rgba(255,99,132,0.5)');
  gradient2.addColorStop(1, 'rgba(255,99,132,0)');

  // --- Screen Time Chart ---
  const screenChart = new Chart(ctx1, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'Screen Time (hrs)',
        data: screenTimes,
        borderColor: '#36A2EB',
        backgroundColor: gradient1,
        fill: true,
        tension: 0.4,
        pointBackgroundColor: '#36A2EB',
        pointRadius: 5,
        pointHoverRadius: 7,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        tooltip: {
          mode: 'index',
          intersect: false,
          callbacks: {
            label: function(ctx) {
              return ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(2) + ' hrs';
            }
          }
        },
        legend: { labels: { color: '#333' } },
        zoom: {
          pan: { enabled: true, mode: 'x' },
          zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
        }
      },
      interaction: { mode: 'nearest', intersect: false },
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'Hours' }
        },
        x: { title: { display: true, text: 'Date' } }
      }
    }
  });

  // --- Risk Score Chart ---
  const riskChart = new Chart(ctx2, {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'Risk Score',
        data: riskScores,
        borderColor: '#FF6384',
        backgroundColor: gradient2,
        fill: true,
        tension: 0.4,
        pointBackgroundColor: riskScores.map(v => v > 0.6 ? '#FF0000' : '#00C853'),
        pointRadius: 6,
        pointHoverRadius: 8,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        tooltip: {
          mode: 'index',
          intersect: false,
          callbacks: {
            label: function(ctx) {
              const risk = ctx.parsed.y > 0.6 ? '⚠️ High Risk' : '✅ Low Risk';
              return `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)} (${risk})`;
            }
          }
        },
        legend: { labels: { color: '#333' } },
        zoom: {
          pan: { enabled: true, mode: 'x' },
          zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 1,
          title: { display: true, text: 'Risk Probability' }
        },
        x: { title: { display: true, text: 'Date' } }
      }
    }
  });
</script>

 <script>
function toggleChatbot() {
  const bot = document.getElementById("chatbot");
  bot.style.display = bot.style.display === "flex" ? "none" : "flex";
}

function sendMessage() {
  const input = document.getElementById("userInput");
  const chatBody = document.getElementById("chatBody");
  const message = input.value.trim();
  if (!message) return;

  // User message bubble
  const userMsg = document.createElement("div");
  userMsg.className = "user-message";
  userMsg.textContent = message;
  chatBody.appendChild(userMsg);

  input.value = "";

  fetch(`/api/students/chatbot/?q=${encodeURIComponent(message)}`)
    .then(res => res.json())
    .then(data => {
      const botMsg = document.createElement("div");
      botMsg.className = "bot-message";
      botMsg.textContent = data.reply;
      chatBody.appendChild(botMsg);
      chatBody.scrollTop = chatBody.scrollHeight;
    })
    .catch(() => {
      const botMsg = document.createElement("div");
      botMsg.className = "bot-message";
      botMsg.textContent = "Sorry, I'm having trouble right now 😞";
      chatBody.appendChild(botMsg);
    });

  chatBody.scrollTop = chatBody.scrollHeight;
}

function startVoice() {
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = 'en-IN';
  recognition.start();

  recognition.onresult = function(event) {
    const message = event.results[0][0].transcript;
    document.getElementById("userInput").value = message;
    sendMessage();
  };

  recognition.onerror = function() {
    alert("Voice recognition failed. Please try again.");
  };
}
</script>
<script>
function analyzeText() {
  const text = document.getElementById('textInput').value;
  fetch(`/ai/analyze-text/?q=${encodeURIComponent(text)}`)
    .then(res => res.json())
    .then(data => {
      document.getElementById('textResult').innerHTML =
        `Result: <b>${data.label}</b> (${data.score || data.confidence || 0}%)<br>Detected: ${data.detected_words || data.detected}`;
    });
}
</script>

</body>
</html>
{% endblock %}
