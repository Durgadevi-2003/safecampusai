{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h3>Addiction Progress Tracker</h3>

  <div class="row g-3">
    <div class="col-md-4">
      <div class="card p-3">
        <h6>Avg Mood</h6>
        <h2>{{ avg_mood }}</h2>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <h6>Avg Craving</h6>
        <h2>{{ avg_craving }}</h2>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <h6>Entries Recorded</h6>
        <h2>{{ milestones.entries_recorded }}</h2>
      </div>
    </div>
  </div>

  <div class="mt-4 card p-3">
    <div class="d-flex justify-content-between">
      <h5>Progress (Last 30 days)</h5>
      <div>
        <a class="btn btn-sm btn-outline-primary" onclick="loadPeriod('7d')">7d</a>
        <a class="btn btn-sm btn-outline-primary" onclick="loadPeriod('30d')">30d</a>
        <a class="btn btn-sm btn-outline-primary" onclick="loadPeriod('monthly')">6 months</a>
      </div>
    </div>
    <canvas id="progressChart" style="height:320px"></canvas>
  </div>
<div class="mt-3">
    <a href="{% url 'addiction_add' %}" class="btn btn-success">+ Add Today’s Entry</a>
    <a href="{% url 'addiction_report_pdf' %}" class="btn btn-danger">⬇️ Download PDF</a>
  </div>
  <div class="mt-4">
    <h5>Recent entries</h5>
    <ul class="list-group">
      {% for e in entries %}
        <li class="list-group-item">
          <strong>{{ e.date }}</strong> — Mood: {{ e.mood }} — Craving: {{ e.craving_level }}
          <p>{{ e.notes|default:"" }}</p>
        </li>
      {% empty %}
        <li class="list-group-item text-muted">No entries yet.</li>
      {% endfor %}
    </ul>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chart = null;
function buildChart(labels, mood, craving, recovery) {
  const ctx = document.getElementById('progressChart').getContext('2d');
  const datasets = [
    { label: 'Mood', data: mood, borderColor: '#28a745', backgroundColor: 'rgba(40,167,69,0.1)', yAxisID: 'y1', spanGaps: true },
    { label: 'Craving', data: craving, borderColor: '#dc3545', backgroundColor: 'rgba(220,53,69,0.1)', yAxisID: 'y1', spanGaps: true },
    { label: 'Recovery Score', data: recovery, borderColor: '#007bff', backgroundColor: 'rgba(0,123,255,0.08)', yAxisID: 'y2', spanGaps: true }
  ];
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'line',
    data: { labels: labels, datasets: datasets },
    options: {
      interaction: { mode: 'index', intersect: false },
      stacked: false,
      scales: {
        y1: { type: 'linear', position: 'left', suggestedMin: 0, suggestedMax: 10 },
        y2: { type: 'linear', position: 'right', suggestedMin: 0, suggestedMax: 100, grid: { drawOnChartArea: false } }
      }
    }
  });
}

function loadPeriod(period='30d') {
  fetch("{% url 'addiction_data' 'PLACEHOLDER' %}".replace('PLACEHOLDER', period))
    .then(r => r.json())
    .then(data => {
      buildChart(data.labels, data.mood, data.craving, data.recovery);
    })
    .catch(e => console.error(e));
}

// initial
document.addEventListener('DOMContentLoaded', () => loadPeriod('30d'));
</script>
{% endblock %}
